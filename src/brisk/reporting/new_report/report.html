<!-- Handle rendering of different pages -->
{%- extends 'components/base.html' -%}

{% block page_renderers %}
{% raw %}
<script>
    // Render reused components
    class TableRenderer {
        constructor(tableData) {
            this.tableData = tableData;
        }

        render() {
            const template = document.getElementById('table-template').content.cloneNode(true);
            this.renderHeaders(template);
            this.renderRows(template);
            this.renderDescription(template);
            return template;
        }

        renderHeaders(template) {
            const headerRow = template.querySelector('.table-header-row');
            this.tableData.columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                headerRow.appendChild(th);
            });
        }

        renderRows(template) {
            const tbody = template.querySelector('.table-body');
            this.tableData.rows.forEach(rowData => {
                const row = document.createElement('tr');

                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        }

        renderDescription(template) {
            const descriptionElement = template.querySelector('.table-description');
            if (this.tableData.description) {
                descriptionElement.textContent = this.tableData.description;
            }
        }
    }


    class ExperimentGroupCardRenderer {
        constructor(cardData, cardIndex) {
            this.cardData = cardData;
            this.cardIndex = cardIndex;
        }

        render() {
            const template = document.getElementById('experiment-group-card-template').content.cloneNode(true);
            this.renderTitle(template);
            this.renderDescription(template);
            this.renderDatasets(template);
            this.renderExperiments(template);
            this.renderDataSplits(template);
            return template;
        }

        renderTitle(template) {
            const titleElement = template.querySelector('.card-title');
            if (this.cardData.group_name) {
                titleElement.textContent = this.cardData.group_name;
            }
        }

        renderDescription(template) {
            const descriptionElement = template.querySelector('.card-description');
            if (this.cardData.description) {
                descriptionElement.textContent = this.cardData.description;
            }
        }

        renderDatasets(template) {
            const datasetContainer = template.querySelector('.group-dataset-container');
            
            if (!this.cardData.dataset_names || this.cardData.dataset_names.length === 0) {
                return;
            }

            this.cardData.dataset_names.forEach((datasetName, index) => {
                const datasetLink = document.createElement('a');
                datasetLink.href = '#';
                datasetLink.className = 'dataset-name';
                datasetLink.textContent = datasetName;
                datasetLink.setAttribute('data-dataset', datasetName);
                
                if (index === 0) {
                    datasetLink.classList.add('selected');
                }
                
                datasetLink.setAttribute('onclick', `selectDataset(this, '${datasetName}', ${this.cardIndex})`);
                datasetContainer.appendChild(datasetLink);
            });
            
            if (this.cardData.dataset_names.length > 0) {
                datasetContainer.setAttribute('data-selected-dataset', this.cardData.dataset_names[0]);
            }
        }

        renderExperiments(template) {
            const experimentList = template.querySelector('.experiment-list');
            
            if (!this.cardData.experiments || this.cardData.experiments.length === 0) {
                return;
            }

            this.cardData.experiments.forEach(experiment => {
                const [experimentName, experimentLink] = experiment;
                
                const listItem = document.createElement('li');
                const experimentAnchor = document.createElement('a');
                experimentAnchor.href = '#';
                experimentAnchor.setAttribute('page-type', 'experiment');
                experimentAnchor.setAttribute('page-data', experimentLink);
                experimentAnchor.className = 'experiment-link';
                experimentAnchor.textContent = experimentName;
                
                listItem.appendChild(experimentAnchor);
                experimentList.appendChild(listItem);
            });
        }

        renderDataSplits(template) {
            const splitSelector = template.querySelector('.data-split-selector');
            
            if (!this.cardData.data_split_scores || Object.keys(this.cardData.data_split_scores).length === 0) {
                return;
            }

            const table = document.createElement('table');
            table.className = 'split-table';
            table.id = `split-table-${this.cardIndex}`;
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Split</th>
                    <th>Best Algorithm</th>
                    <th>CCC</th>
                </tr>
            `;
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            
            const firstDataset = this.cardData.dataset_names[0];
            const firstDatasetSplits = this.cardData.data_split_scores[firstDataset];
            
            if (firstDatasetSplits) {
                firstDatasetSplits.forEach((split, index) => {
                    const [splitName, algorithm, score] = split;
                    
                    const row = document.createElement('tr');
                    row.className = 'split-row';
                    if (index === 0) {
                        row.classList.add('selected');
                    }
                    row.setAttribute('onclick', 'selectSplit(this)');
                    
                    row.innerHTML = `
                        <td class="split-name">${splitName}</td>
                        <td class="algorithm">${algorithm}</td>
                        <td class="score">${score}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            splitSelector.appendChild(table);
        }
    }


    // Class to process json data for each page type
    class HomeRenderer {
        constructor(data) {
            this.data = data;
        }

        render() {
            const template = document.getElementById('home-template').content.cloneNode(true);
            this.renderTables(template);
            this.renderExperimentGroupCards(template);
            return template;
        }

        renderTables(template) {
            const container = template.querySelector('.tables-container');

            if (!this.data.tables || this.data.tables.length === 0) {
                return;
            }

            this.data.tables.forEach(tableData => {
                const tableRenderer = new TableRenderer(tableData);
                const tableElement = tableRenderer.render();
                container.appendChild(tableElement);
            });
        }

        renderExperimentGroupCards(template) {
            const container = template.querySelector('#cards-track');

            if (!this.data.experiment_group_cards || Object.keys(this.data.experiment_group_cards).length === 0) {
                return;
            }

            Object.entries(this.data.experiment_group_cards).forEach(([groupName, cardData], index) => {
                const cardRenderer = new ExperimentGroupCardRenderer(cardData, index);
                const cardElement = cardRenderer.render();
                container.appendChild(cardElement);
            });
        }
    }


    // Client side page rendering
    function renderPage(pageType, pageData = null) {
        switch(pageType) {
            case 'home':
                return renderHomePage();
            case 'experiment':
                return renderExperimentPage(pageData);
            case 'dataset':
                return renderDatasetPage(pageData);
            default:
                return '<div>Page not found</div>';
        }
    }


    function renderHomePage() {
        const renderer = new HomeRenderer({
            tables: reportData.tables,
            experiment_group_cards: reportData.experiment_group_cards
        });

        const renderedElement = renderer.render();
        const tempDiv = document.createElement('div');
        tempDiv.appendChild(renderedElement);
        return tempDiv.innerHTML;
    }
</script>
{% endraw %}
{% endblock %}