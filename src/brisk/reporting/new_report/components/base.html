<!-- Defines the structure of all report pages and handles navigation -->
<!DOCTYPE html>
<html>
<!-- Embed all data as JSON -->
<script type="application/json" id="report-data">
    {{ report_json }}
</script>
<!-- Navigation Framework -->
{% raw %}
<script>
    let reportData = {};
    let currentPage = 'home';
    let currentExperimentGroupCard = 0;

    // Theme management
    function toggleTheme() {
        const root = document.documentElement;
        const themeText = document.querySelector('.theme-text');
        const darkIcon = document.querySelector('.dark-mode-icon');
        const lightIcon = document.querySelector('.light-mode-icon');
        
        if (root.classList.contains('light-theme')) {
            // Switch to dark theme
            root.classList.remove('light-theme');
            themeText.textContent = 'Light Mode';
            lightIcon.style.display = 'block';
            darkIcon.style.display = 'none';
            localStorage.setItem('theme', 'dark');
        } else {
            // Switch to light theme
            root.classList.add('light-theme');
            themeText.textContent = 'Dark Mode';
            lightIcon.style.display = 'none';
            darkIcon.style.display = 'block';
            localStorage.setItem('theme', 'light');
        }
    }

    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme');
        const root = document.documentElement;
        const themeText = document.querySelector('.theme-text');
        const darkIcon = document.querySelector('.dark-mode-icon');
        const lightIcon = document.querySelector('.light-mode-icon');
        
        if (savedTheme === 'light') {
            root.classList.add('light-theme');
            themeText.textContent = 'Dark Mode';
            lightIcon.style.display = 'none';
            darkIcon.style.display = 'block';
        } else {
            root.classList.remove('light-theme');
            themeText.textContent = 'Light Mode';
            lightIcon.style.display = 'block';
            darkIcon.style.display = 'none';
        }
    }

    // Initalize the app
    document.addEventListener('DOMContentLoaded', function() {
        const dataElement = document.getElementById('report-data')
        if (!dataElement) {
            console.error('report-data element not found!');
            return;
        }
        try {
            reportData = JSON.parse(dataElement.textContent);
        } catch (e) {
            console.error('Failed to parse report data:', e)
            return;
        }

        showPage('home');
        setupNavigation();
    });

    // Switch to a different page type
    function showPage(pageType, pageData = null) {
        const mainContent = document.getElementById('main-content');
        currentPage = pageType;

        try {
            let content = renderPage(pageType, pageData);
            mainContent.innerHTML = content;

            if (pageType === 'home') {
                // Ensure DOM is ready first
                setTimeout(initializeCarousel, 50);
            }
        } catch (e) {
            console.error('Error rendering page:', e);
            mainContent.innerHTML = '<div>Error rendering page: ' + e.message + '</div>';
        }
    }

    function renderPage(pageType, pageData = null) {
    //  Rendering logic is implemented by report.html
            return '<div>No renderer found</div>';
        }

    // Add event listener for page-type
    function setupNavigation() {
        document.addEventListener('click', function(event) {
            if (event.target.matches('[page-type]')) {
                event.preventDefault();
                const pageType = event.target.getAttribute('page-type');
                const pageData = event.target.getAttribute('page-data');
                showPage(pageType, pageData)
            }
        });
    }

    // Select Dataset (Home ExperimentGroup Cards)
    function selectDataset(clickedElement, datasetName, cardIndex) {
        const card = clickedElement.closest('.experiment-group-card');
        const allDatasetItems = card.querySelectorAll('.dataset-name');
        allDatasetItems.forEach(item => item.classList.remove('selected'));
        
        // Add selected class to clicked item
        clickedElement.classList.add('selected');

        // Prevent default link behavior
        return false;
    }

    // ExperimentGroup Card Carousel Control
    function initializeCarousel() {
        const cards = document.querySelectorAll(".experiment-card-wrapper");
        if (cards.length === 0) return;

        currentExperimentGroupCard = 0;
        updateCarousel();
    }

    function navigateCards(direction) {
        const cards = document.querySelectorAll(".experiment-card-wrapper");
        if (cards.length === 0) return;
        
        currentExperimentGroupCard = (currentExperimentGroupCard + direction + cards.length) % cards.length;
        updateCarousel();
    }

    function updateCarouselHeight() {
        const activeCard = document.querySelector('.experiment-card-wrapper.active');
        const viewport = document.querySelector('.cards-viewport');
        const track = document.querySelector('.cards-track');
        
        if (activeCard && viewport && track) {
            setTimeout(() => {
                const cardContent = activeCard.querySelector('.experiment-group-card');
                if (cardContent) {
                    const cardHeight = cardContent.scrollHeight;
                    const totalHeight = Math.max(cardHeight + 25, 400);                    
                    viewport.style.height = totalHeight + 'px';
                    track.style.height = totalHeight + 'px';
                }
            }, 50);
        }
    }

    function updateCarousel() {
        const cards = document.querySelectorAll(".experiment-card-wrapper");

        cards.forEach((card, index) => {
            card.classList.remove('active', 'above', 'below', 'hidden');

            if (index === currentExperimentGroupCard) {
                card.classList.add('active');
            } else if (index === (currentExperimentGroupCard - 1 + cards.length) % cards.length) {
                card.classList.add('above');
            } else if (index === (currentExperimentGroupCard + 1) % cards.length) {
                card.classList.add('below');
            } else {
                card.classList.add('hidden');
            }
        });
        updateCarouselHeight();
    }

    window.navigateCards = navigateCards; // Make function global for onclick handlers
</script>
{% endraw %}
{% block page_renderers %}
<!-- Page rendering logic will be included here from report.html -->
{% endblock %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brisk Report</title>
    <style>
        {{ base_css }}
        {{ navbar_css }}
        {{ table_css }}
        {{ experiment_group_card_css }}
        {{ home_css }}
    </style>
    <template id="home-template">
        {{ home_template|safe }}
    </template>
    <template id="table-template">
        {{ table_component|safe }}
    </template>
    <template id="experiment-group-card-template">
        {{ experiment_group_card_component|safe }}
    </template>
</head>
<body>
    {% with navbar = report.navbar %}
        {% include 'components/navbar.html' %}
    {% endwith %}

    <main id="main-content">
        <!-- Content will be dynamically inserted here by showPage-->
    </main>
</body>
</html>